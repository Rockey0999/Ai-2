<!DOCTYPE html>
<html>
<head>
    <title>MoodMirror Real-Time</title>
    <script defer src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <style>
        body { background: #0d1117; color: white; font-family: sans-serif; text-align: center; }
        .video-box { position: relative; display: inline-block; border: 2px solid #00ff88; border-radius: 10px; overflow: hidden; }
        canvas { position: absolute; top: 0; left: 0; }
        #advice-panel { margin-top: 20px; font-size: 1.2em; color: #00ff88; min-height: 50px; }
    </style>
</head>
<body>
    <h1>MOODMIRROR <span id="loading-status">(Loading AI...)</span></h1>
    <div class="video-box">
        <video id="web" width="640" height="480" autoplay muted playsinline></video>
        <canvas id="overlay"></canvas>
    </div>
    <div id="advice-panel">Waiting for face detection...</div>

    <script type="mpy" src="./logic.py" config='{"packages":[]}'></script>

    <script>
        const video = document.getElementById('web');
        const adviceDiv = document.getElementById('advice-panel');

        async function start() {
            // Using absolute CDN paths for models to prevent 404s
            const URL = 'https://vladmandic.github.io/face-api/model/';
            await faceapi.nets.tinyFaceDetector.loadFromUri(URL);
            await faceapi.nets.faceExpressionNet.loadFromUri(URL);
            
            const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            video.srcObject = stream;
            document.getElementById('loading-status').innerText = "âœ… LIVE";
        }

        video.addEventListener('play', () => {
            setInterval(async () => {
                const detect = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
                if (detect) {
                    const top = Object.keys(detect.expressions).reduce((a, b) => detect.expressions[a] > detect.expressions[b] ? a : b);
                    
                    // Call the Python function from logic.py
                    const pyscript = document.querySelector('script[type="mpy"]')._py;
                    if (pyscript) {
                        const result = pyscript.resolve('get_study_advice')(top);
                        adviceDiv.innerText = result;
                    }
                }
            }, 300); // 3 times per second
        });
        start();
    </script>
</body>
</html>
